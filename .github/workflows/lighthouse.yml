name: Lighthouse CI

on:
  pull_request:
    branches:
      - develop # develop ë¸Œëœì¹˜ë¡œ ê°€ëŠ” PRë§Œ ì‹¤í–‰
    types: [closed] # PRì´ ë‹«í ë•Œ ì‹¤í–‰

permissions:
  issues: write
  contents: read

jobs:
  lighthouse-audit:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Install dependencies
        run: |
          pnpm add -g @lhci/cli@0.14.x
          pnpm add -g http-server

      - name: Start local server
        run: http-server . -p 8080 &

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          URL="${{ github.event.inputs.url || 'http://localhost:8080' }}"
          lhci autorun --collect.url=$URL

      - name: Create GitHub Issue with Results
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const lhciDir = '.lighthouseci';
            const jsonReports = fs.readdirSync(lhciDir).filter(f => f.endsWith('.json'));
            const latestReport = jsonReports.sort().reverse()[0];
            const reportPath = path.join(lhciDir, latestReport);
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const formatAssertions = (report) => {
              const assertions = [];
              
              // ë¸Œë¼ìš°ì € ì½˜ì†” ì—ëŸ¬
              if (report.audits['errors-in-console']?.score === 0) {
                assertions.push({
                  category: 'ë¸Œë¼ìš°ì € ì˜¤ë¥˜',
                  issue: 'Console ì—ëŸ¬ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.',
                  fix: 'ë¸Œë¼ìš°ì € ì½˜ì†”ì— ê¸°ë¡ëœ ì—ëŸ¬ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.',
                  link: 'https://developer.chrome.com/docs/lighthouse/best-practices/errors-in-console/'
                });
              }

              // ì ‘ê·¼ì„± ë¬¸ì œ
              if (report.audits['html-has-lang']?.score === 0) {
                assertions.push({
                  category: 'ì ‘ê·¼ì„±',
                  issue: 'HTML lang ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤.',
                  fix: '<html> íƒœê·¸ì— lang ì†ì„±ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”. ì˜ˆ: <html lang="ko">',
                  link: 'https://dequeuniversity.com/rules/axe/4.9/html-has-lang'
                });
              }

              // SEO ë¬¸ì œ
              if (report.audits['meta-description']?.score === 0) {
                assertions.push({
                  category: 'SEO',
                  issue: 'meta descriptionì´ ì—†ìŠµë‹ˆë‹¤.',
                  fix: '<head> íƒœê·¸ ë‚´ì— ë©”íƒ€ ì„¤ëª…ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.',
                  link: 'https://developer.chrome.com/docs/lighthouse/seo/meta-description/'
                });
              }

              // ì„±ëŠ¥ ë¬¸ì œ
              if (report.audits['unused-css-rules']?.details?.items?.length > 0) {
                assertions.push({
                  category: 'ì„±ëŠ¥',
                  issue: 'ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” CSSê°€ ìˆìŠµë‹ˆë‹¤.',
                  fix: 'ë¶ˆí•„ìš”í•œ CSSë¥¼ ì œê±°í•˜ê±°ë‚˜ í•„ìš”í•œ CSSë§Œ ë¡œë“œí•˜ë„ë¡ ìˆ˜ì •í•´ì£¼ì„¸ìš”.',
                  link: 'https://developer.chrome.com/docs/lighthouse/performance/unused-css-rules/'
                });
              }

              return assertions;
            };

            const formatScore = (value = 0) => {
              return Math.round(value * 100);
            };

            const getEmoji = (value, metric) => {
              const thresholds = {
                LCP: { good: 2500, needsImprovement: 4000 },
                INP: { good: 200, needsImprovement: 500 },
                CLS: { good: 0.1, needsImprovement: 0.25 },
              };
              
              if (!thresholds[metric]) return value >= 90 ? 'ğŸŸ¢' : value >= 50 ? 'ğŸŸ ' : 'ğŸ”´';
              
              const t = thresholds[metric];
              return value <= t.good ? 'ğŸŸ¢' : value <= t.needsImprovement ? 'ğŸŸ ' : 'ğŸ”´';
            };

            const formatMetric = (value, metric) => {
              if (!value) return 'N/A';
              if (metric === 'CLS') return value.toFixed(3);
              return `${(value / 1000).toFixed(2)}s`;
            };

            const getLighthouseResult = (report, category) => {
              try {
                return report.categories?.[category]?.score ?? 0;
              } catch (e) {
                return 0;
              }
            };

            const getMetricValue = (report, metric) => {
              try {
                return report.audits?.[metric]?.numericValue ?? 0;
              } catch (e) {
                return 0;
              }
            };

            const lighthouseScores = {
              performance: getLighthouseResult(report, 'performance'),
              accessibility: getLighthouseResult(report, 'accessibility'),
              'best-practices': getLighthouseResult(report, 'best-practices'),
              seo: getLighthouseResult(report, 'seo'),
              pwa: getLighthouseResult(report, 'pwa')
            };

            const webVitals = {
              LCP: getMetricValue(report, 'largest-contentful-paint'),
              INP: getMetricValue(report, 'experimental-interaction-to-next-paint'),
              CLS: getMetricValue(report, 'cumulative-layout-shift')
            };

            const reportUrl = `.lighthouseci/${latestReport.replace('.json', '.html')}`;

            const body = `## ğŸš¨ ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼

            ### ğŸ“Œ ì‹¤í–‰ ì •ë³´
            - Branch: \`${context.ref.replace('refs/heads/', '')}\`
            - Commit: [\`${context.sha.substring(0, 7)}\`](${context.payload.repository.html_url}/commit/${context.sha})
            - Message: ${context.payload.head_commit?.message || '(no message)'}
            - Author: ${context.payload.head_commit?.author?.name || '(unknown)'}

            ### âŒ í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨ í•­ëª©
            ${formatAssertions(report).map(assertion => `
            #### ${assertion.category}
            - **ë¬¸ì œ**: ${assertion.issue}
            - **ê°œì„ ë°©ì•ˆ**: ${assertion.fix}
            - **ì°¸ê³ ë¬¸ì„œ**: [ê°€ì´ë“œ ë¬¸ì„œ](${assertion.link})
            `).join('\n')}

            ### ğŸ¯ Lighthouse ì ìˆ˜
            | ì¹´í…Œê³ ë¦¬ | ì ìˆ˜ | ìƒíƒœ |
            |----------|------|------|
            | Performance | ${formatScore(lighthouseScores.performance)}% | ${getEmoji(formatScore(lighthouseScores.performance))} |
            | Accessibility | ${formatScore(lighthouseScores.accessibility)}% | ${getEmoji(formatScore(lighthouseScores.accessibility))} |
            | Best Practices | ${formatScore(lighthouseScores['best-practices'])}% | ${getEmoji(formatScore(lighthouseScores['best-practices']))} |
            | SEO | ${formatScore(lighthouseScores.seo)}% | ${getEmoji(formatScore(lighthouseScores.seo))} |
            | PWA | ${formatScore(lighthouseScores.pwa)}% | ${getEmoji(formatScore(lighthouseScores.pwa))} |

            ### ğŸ“Š Core Web Vitals (2024)
            | ë©”íŠ¸ë¦­ | ì„¤ëª… | ì¸¡ì •ê°’ | ìƒíƒœ |
            |--------|------|--------|------|
            | LCP | Largest Contentful Paint | ${formatMetric(webVitals.LCP, 'LCP')} | ${getEmoji(webVitals.LCP, 'LCP')} |
            | INP | Interaction to Next Paint | ${formatMetric(webVitals.INP, 'INP')} | ${getEmoji(webVitals.INP, 'INP')} |
            | CLS | Cumulative Layout Shift | ${formatMetric(webVitals.CLS, 'CLS')} | ${getEmoji(webVitals.CLS, 'CLS')} |

            ### ğŸ“ Core Web Vitals ê¸°ì¤€ê°’
            - **LCP (Largest Contentful Paint)**: ê°€ì¥ í° ì½˜í…ì¸ ê°€ í™”ë©´ì— ê·¸ë ¤ì§€ëŠ” ì‹œì  
              - ğŸŸ¢ Good: < 2.5s
              - ğŸŸ  Needs Improvement: < 4.0s
              - ğŸ”´ Poor: â‰¥ 4.0s

            - **INP (Interaction to Next Paint)**: ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì— ëŒ€í•œ ì „ë°˜ì ì¸ ì‘ë‹µì„±
              - ğŸŸ¢ Good: < 200ms
              - ğŸŸ  Needs Improvement: < 500ms
              - ğŸ”´ Poor: â‰¥ 500ms

            - **CLS (Cumulative Layout Shift)**: í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ë ˆì´ì•„ì›ƒ ë³€ê²½ì˜ ì •ë„
              - ğŸŸ¢ Good: < 0.1
              - ğŸŸ  Needs Improvement: < 0.25
              - ğŸ”´ Poor: â‰¥ 0.25

            > ğŸ“… ì¸¡ì • ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ - ${new Date().toLocaleString('ko-KR', { 
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
              })}`,
              body: body,
              labels: ['lighthouse-audit', 'web-vitals']
            });
